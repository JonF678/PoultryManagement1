class Analytics {
    constructor() {
        this.cycle = null;
        this.cycles = [];
        this.cages = [];
        this.productionLogs = [];
        this.feedLogs = [];
        this.sales = [];
        this.expenses = [];
        this.currentFilter = 'all';
        this.dateRange = 30; // days
        this.metricType = 'feed'; // Default metric type
        this.timePeriod = 'day'; // day, week, month, year
    }

    async init(cycleId = null) {
        try {
            // Ensure database is initialized
            if (!db || !db.db) {
                throw new Error('Database not initialized');
            }

            if (cycleId) {
                this.cycle = await db.get('cycles', parseInt(cycleId));
                this.cages = await db.getByIndex('cages', 'cycleId', parseInt(cycleId));
                this.productionLogs = await db.getByIndex('productionLogs', 'cycleId', parseInt(cycleId));
                this.feedLogs = await db.getByIndex('feedLogs', 'cycleId', parseInt(cycleId));
                this.sales = await db.getByIndex('sales', 'cycleId', parseInt(cycleId));
                this.expenses = await db.getByIndex('expenses', 'cycleId', parseInt(cycleId));
            } else {
                // Load all data for overall analytics
                this.cycle = null;
                this.cycles = await db.getAll('cycles');
                this.cages = await db.getAll('cages');
                this.productionLogs = await db.getAll('productionLogs');
                this.feedLogs = await db.getAll('feedLogs');
                this.sales = await db.getAll('sales');
                this.expenses = await db.getAll('expenses');
            }

            // Initialize arrays if they're undefined
            this.cycles = this.cycles || [];
            this.cages = this.cages || [];
            this.productionLogs = this.productionLogs || [];
            this.feedLogs = this.feedLogs || [];
            this.sales = this.sales || [];
            this.expenses = this.expenses || [];

            this.render();
            this.loadAnalytics();
        } catch (error) {
            console.error('Error initializing analytics:', error);
            this.renderError();
        }
    }

    render() {
        const content = `
            <div class="analytics fade-in">
                ${this.renderHeader()}
                ${this.renderFilters()}
                ${this.renderKPIs()}
                ${this.renderCharts()}
                ${this.renderTables()}
            </div>
        `;

        document.getElementById('app-content').innerHTML = content;
    }

    renderHeader() {
        return `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Analytics Dashboard</h2>
                    <p class="text-muted mb-0">
                        ${this.cycle ? `Cycle: ${this.cycle.name}` : 'All Cycles Overview'}
                    </p>
                </div>
                <div>
                    ${this.cycle ? `
                        <div class="btn-group me-2">
                            <button class="btn btn-outline-success" onclick="router.navigate('sales', {cycleId: ${this.cycle.id}})">
                                <i class="fas fa-shopping-cart me-2"></i>Sales
                            </button>
                            <button class="btn btn-outline-danger" onclick="router.navigate('expenses', {cycleId: ${this.cycle.id}})">
                                <i class="fas fa-receipt me-2"></i>Expenses
                            </button>
                            <button class="btn btn-outline-info" onclick="router.navigate('vaccinations', {cycleId: ${this.cycle.id}})">
                                <i class="fas fa-syringe me-2"></i>Vaccinations
                            </button>
                        </div>
                    ` : ''}
                    <button class="btn btn-outline-primary me-2" onclick="analytics.exportData()">
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    ${this.cycle ? `
                        <button class="btn btn-outline-secondary" onclick="router.navigate('cage-manager', {cycleId: ${this.cycle.id}})">
                            <i class="fas fa-arrow-left me-2"></i>Back to Cages
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    renderFilters() {
        return `
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        ${!this.cycle ? `
                        <div class="col-md-3">
                            <label for="cycleFilter" class="form-label">Cycle Filter</label>
                            <select class="form-select" id="cycleFilter" onchange="analytics.updateCycleFilter(this.value)">
                                <option value="all">All Cycles</option>
                                ${this.cycles ? this.cycles.map(cycle => `<option value="${cycle.id}">${cycle.name}</option>`).join('') : ''}
                            </select>
                        </div>
                        ` : ''}
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange" onchange="analytics.updateDateRange(this.value)">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="timePeriod" class="form-label">Time Period</label>
                            <select class="form-select" id="timePeriod" onchange="analytics.updateTimePeriod(this.value)">
                                <option value="day" selected>Daily</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                                <option value="year">Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="metricType" class="form-label">Primary Metric</label>
                            <select class="form-select" id="metricType" onchange="analytics.updateMetricType(this.value)">
                                <option value="production">Egg Production</option>
                                <option value="efficiency">Laying Efficiency</option>
                                <option value="feed" selected>Feed Consumption</option>
                                <option value="mortality">Mortality Rate</option>
                                <option value="profit">Profit Analysis</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary mt-4" onclick="analytics.refreshAnalytics()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    renderKPIs() {
        return `
            <div class="row mb-4" id="kpi-cards">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stats-value text-primary" id="total-production">-</div>
                            <div class="stats-label">Total Production</div>
                            <small class="text-muted" id="production-trend">-</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stats-value text-success" id="avg-laying-rate">-</div>
                            <div class="stats-label">Avg Laying Rate</div>
                            <small class="text-muted" id="laying-trend">-</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stats-value text-warning" id="feed-efficiency">-</div>
                            <div class="stats-label">Feed Efficiency</div>
                            <small class="text-muted" id="feed-trend">-</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="stats-value text-info" id="cycle-profit">-</div>
                            <div class="stats-label">Cycle Profit</div>
                            <small class="text-muted" id="profit-trend">-</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    renderCharts() {
        return `
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0" id="main-chart-title">Production Trends</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="productionTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Cage Performance</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="cagePerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        `;
    }

    renderTables() {
        return `
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Top Performing Cages</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Cage</th>
                                            <th>Total Eggs</th>
                                            <th>Laying Rate</th>
                                            <th>Feed Efficiency</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="performance-table">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Quick Insights</h6>
                        </div>
                        <div class="card-body">
                            <div id="insights-list">
                                <!-- Insights will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    renderError() {
        const content = `
            <div class="text-center mt-5">
                <i class="fas fa-chart-line text-muted" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Analytics Unavailable</h4>
                <p class="text-muted">Unable to load analytics data. Please try again.</p>
                <button class="btn btn-primary" onclick="analytics.init()">
                    <i class="fas fa-sync-alt me-2"></i>Retry
                </button>
            </div>
        `;
        document.getElementById('app-content').innerHTML = content;
    }

    async loadAnalytics() {
        this.loadKPIs();
        this.loadCharts();
        this.loadPerformanceTable();
        this.loadInsights();
    }

    loadKPIs() {
        const filteredLogs = this.getFilteredLogs();
        const filteredFeedLogs = this.getFilteredFeedLogs();

        // Total production - convert trays to eggs (1 tray = 30 eggs)
        const totalProduction = filteredLogs.reduce((sum, log) => {
            const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
            return sum + eggs;
        }, 0);
        document.getElementById('total-production').textContent = totalProduction.toLocaleString();

        // Average laying rate
        const totalBirds = this.cages.reduce((sum, cage) => sum + (cage.currentBirds || 0), 0);
        const avgLayingRate = totalBirds > 0 ? 
            Calculations.calculateLayingPercentage(totalProduction, totalBirds, filteredLogs.length || 1) : 0;
        document.getElementById('avg-laying-rate').textContent = `${avgLayingRate.toFixed(1)}%`;

        // Feed efficiency
        const totalFeed = filteredFeedLogs.reduce((sum, log) => sum + (log.feedConsumed || log.amount || 0), 0);
        const productionLogsFeed = filteredLogs.reduce((sum, log) => sum + (log.currentFeed || 0), 0);
        const combinedFeed = totalFeed + productionLogsFeed;
        const feedEfficiency = Calculations.calculateFeedEfficiency(totalProduction, combinedFeed);
        console.log(`KPI Debug - Total Production: ${totalProduction}, Feed Logs Total: ${totalFeed}, Production Logs Feed: ${productionLogsFeed}, Combined Feed: ${combinedFeed}, Efficiency: ${feedEfficiency}`);
        document.getElementById('feed-efficiency').textContent = feedEfficiency.toFixed(2);

        // Cycle Profit - Debug logging
        console.log('Sales data:', this.sales);
        console.log('Expenses data:', this.expenses);
        
        const totalRevenue = this.sales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
        const totalExpenses = this.expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
        const profit = totalRevenue - totalExpenses;
        const roi = totalExpenses > 0 ? ((profit / totalExpenses) * 100) : 0;
        
        console.log('Total Revenue:', totalRevenue);
        console.log('Total Expenses:', totalExpenses);
        console.log('Profit:', profit);
        console.log('ROI:', roi);
        
        document.getElementById('cycle-profit').textContent = `₵${profit.toFixed(2)}`;
        document.getElementById('profit-trend').textContent = `ROI: ${roi.toFixed(1)}%`;
    }

    loadCharts() {
        // Update the selected values in the dropdowns
        const metricSelect = document.getElementById('metricType');
        if (metricSelect) {
            metricSelect.value = this.metricType;
        }

        const timePeriodSelect = document.getElementById('timePeriod');
        if (timePeriodSelect) {
            timePeriodSelect.value = this.timePeriod;
        }

        // Load the main trend chart based on selected metric
        this.loadMetricBasedChart();
        
        // Always load cage performance chart
        this.loadCagePerformanceChart();
    }

    loadMetricBasedChart() {
        // Update chart title based on metric type and time period
        const chartTitles = {
            'production': `Egg Production Trends (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`,
            'efficiency': `Laying Efficiency Trends (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`,
            'feed': `Feed Consumption Trends (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`,
            'mortality': `Mortality Trends (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`,
            'profit': `Profit Analysis (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`
        };
        
        const titleElement = document.getElementById('main-chart-title');
        if (titleElement) {
            titleElement.textContent = chartTitles[this.metricType] || `Production Trends (${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly)`;
        }

        switch (this.metricType) {
            case 'production':
                this.loadProductionTrendChart();
                break;
            case 'efficiency':
                this.loadEfficiencyChart();
                break;
            case 'feed':
                this.loadFeedChart();
                break;
            case 'mortality':
                this.loadMortalityChart();
                break;
            case 'profit':
                this.loadProfitChart();
                break;
            default:
                this.loadProductionTrendChart();
        }
    }

    loadProductionTrendChart() {
        const filteredLogs = this.getFilteredLogs();
        
        if (filteredLogs.length === 0) {
            // Show no data message
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No production data available yet.</p>
                    <small>Start logging daily production to see trends.</small>
                </div>
            `;
            return;
        }
        
        // Group data by selected time period
        try {
            const groupedData = Calculations.groupDataByPeriod(filteredLogs, this.timePeriod);
            const labels = Object.keys(groupedData).sort();
            
            const productionData = labels.map(period => {
                const periodLogs = groupedData[period];
                return periodLogs.reduce((sum, log) => {
                    const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                    return sum + eggs;
                }, 0);
            });

            const layingData = labels.map(period => {
                const periodLogs = groupedData[period];
                const totalEggs = periodLogs.reduce((sum, log) => {
                    const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                    return sum + eggs;
                }, 0);
                const totalBirds = this.cages.reduce((sum, cage) => sum + (cage.currentBirds || 0), 0);
                const daysInPeriod = this.timePeriod === 'day' ? 1 : this.timePeriod === 'week' ? 7 : this.timePeriod === 'month' ? 30 : 365;
                const layingRate = totalBirds > 0 ? Calculations.calculateLayingPercentage(totalEggs, totalBirds, daysInPeriod) : 0;
                console.log(`Debug laying rate - Period: ${period}, Eggs: ${totalEggs}, Birds: ${totalBirds}, Days: ${daysInPeriod}, Rate: ${layingRate}%`);
                return layingRate;
            });

            const chartData = {
                labels: labels.map(label => Calculations.formatDate(label, this.timePeriod)),
                datasets: [
                    {
                        label: `${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly Production (Eggs)`,
                        data: productionData,
                        color: '#2563eb',
                        fill: true,
                        yAxisID: 'y'
                    },
                {
                    label: 'Laying Rate (%)',
                    data: layingData,
                    color: '#10b981',
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        };

        const chartOptions = {
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Eggs Produced'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    suggestedMax: 100,
                    title: {
                        display: true,
                        text: 'Laying Rate (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        };

        console.log('Production Chart Data:', {
            labels: chartData.labels,
            productionData: productionData,
            layingData: layingData,
            chartOptions: chartOptions
        });

        setTimeout(() => {
            chartManager.createLineChart('productionTrendChart', chartData, chartOptions);
        }, 100);
    }

    loadCagePerformanceChart() {
        if (this.cages.length === 0) {
            document.getElementById('cagePerformanceChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-home fa-2x mb-3"></i>
                    <p>No cages available.</p>
                    <small>Add cages to see performance comparison.</small>
                </div>
            `;
            return;
        }

        const cagePerformance = this.cages.map(cage => {
            const cageLogs = this.productionLogs.filter(log => log.cageId === cage.id);
            const totalEggs = cageLogs.reduce((sum, log) => {
                const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                return sum + eggs;
            }, 0);
            const avgLayingRate = cage.currentBirds > 0 ?
                Calculations.calculateLayingPercentage(totalEggs, cage.currentBirds, cageLogs.length || 1) : 0;
            
            return {
                name: cage.name,
                performance: avgLayingRate
            };
        });

        cagePerformance.sort((a, b) => b.performance - a.performance);

        const chartData = {
            labels: cagePerformance.map(cage => cage.name),
            datasets: [{
                label: 'Laying Rate %',
                data: cagePerformance.map(cage => cage.performance),
                color: '#8b5cf6'
            }]
        };

        setTimeout(() => {
            chartManager.createBarChart('cagePerformanceChart', chartData);
        }, 100);
    }

    loadFeedChart() {
        const filteredFeedLogs = this.getFilteredFeedLogs();
        
        if (filteredFeedLogs.length === 0) {
            // Show no data message
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No feed consumption data available yet.</p>
                    <small>Start logging feed consumption to see trends.</small>
                </div>
            `;
            return;
        }
        
        // Group data by selected time period
        try {
            const groupedFeedData = Calculations.groupDataByPeriod(filteredFeedLogs, this.timePeriod);
            const labels = Object.keys(groupedFeedData).sort();
            
            const feedData = labels.map(period => {
                const periodLogs = groupedFeedData[period];
                return periodLogs.reduce((sum, log) => sum + (log.feedConsumed || log.amount || 0), 0);
            });

            const chartData = {
                labels: labels.map(label => Calculations.formatDate(label, this.timePeriod)),
                datasets: [{
                    label: `${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly Feed (kg)`,
                    data: feedData,
                    color: '#f59e0b'
                }]
            };

            setTimeout(() => {
                chartManager.createBarChart('productionTrendChart', chartData);
            }, 100);
        } catch (error) {
            console.error('Error in loadFeedChart:', error);
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>Error loading feed chart</p>
                    <small>Please try refreshing or contact support</small>
                </div>
            `;
        }
    }

    loadEfficiencyChart() {
        const recentLogs = this.getFilteredLogs().slice(-30);
        
        if (recentLogs.length === 0) {
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No production data available for efficiency analysis.</p>
                    <small>Start logging daily production to see laying efficiency trends.</small>
                </div>
            `;
            return;
        }
        
        const efficiencyData = recentLogs.map(log => {
            const feedLog = this.feedLogs.find(f => f.date === log.date && f.cycleId === log.cycleId);
            const feedAmount = feedLog?.feedConsumed || feedLog?.amount || log.currentFeed || 0;
            const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
            const efficiency = Calculations.calculateFeedEfficiency(eggs, feedAmount);
            console.log(`Debug efficiency - Date: ${log.date}, Eggs: ${eggs}, Feed: ${feedAmount}, Efficiency: ${efficiency}`);
            return efficiency;
        });

        const movingAvg = Calculations.calculateMovingAverage(efficiencyData, 7);

        const chartData = {
            labels: recentLogs.slice(-movingAvg.length).map(log => Calculations.formatDate(log.date)),
            datasets: [
                {
                    label: 'Daily Efficiency',
                    data: efficiencyData.slice(-movingAvg.length),
                    color: '#06b6d4',
                    fill: false
                },
                {
                    label: '7-Day Average',
                    data: movingAvg,
                    color: '#ef4444',
                    fill: false
                }
            ]
        };

        setTimeout(() => {
            chartManager.createLineChart('productionTrendChart', chartData);
        }, 100);
    }

    loadMortalityChart() {
        const filteredLogs = this.getFilteredLogs();
        
        if (filteredLogs.length === 0) {
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No mortality data available yet.</p>
                    <small>Start logging daily production to see mortality trends.</small>
                </div>
            `;
            return;
        }

        // Group data by selected time period
        try {
            const groupedData = Calculations.groupDataByPeriod(filteredLogs, this.timePeriod);
            const labels = Object.keys(groupedData).sort();
            
            const mortalityData = labels.map(period => {
                const periodLogs = groupedData[period];
                return periodLogs.reduce((sum, log) => sum + (log.mortality || 0), 0);
            });

            const mortalityRateData = labels.map(period => {
                const periodLogs = groupedData[period];
                const totalMortality = periodLogs.reduce((sum, log) => sum + (log.mortality || 0), 0);
                const totalBirds = this.cages.reduce((sum, cage) => sum + (cage.currentBirds || 0), 0);
                return totalBirds > 0 ? (totalMortality / totalBirds) * 100 : 0;
            });

            const chartData = {
                labels: labels.map(label => Calculations.formatDate(label, this.timePeriod)),
                datasets: [
                    {
                        label: `${this.timePeriod.charAt(0).toUpperCase() + this.timePeriod.slice(1)}ly Mortality Count`,
                        data: mortalityData,
                        color: '#ef4444',
                        fill: true,
                        yAxisID: 'y'
                    },
                {
                    label: 'Mortality Rate (%)',
                    data: mortalityRateData,
                    color: '#f97316',
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        };

        const chartOptions = {
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Mortality Count'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    suggestedMax: 100,
                    title: {
                        display: true,
                        text: 'Mortality Rate (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        };

        setTimeout(() => {
            chartManager.createLineChart('productionTrendChart', chartData, chartOptions);
        }, 100);
    }

    loadProfitChart() {
        if (this.sales.length === 0 && this.expenses.length === 0) {
            document.getElementById('productionTrendChart').parentElement.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>No financial data available yet.</p>
                    <small>Start recording sales and expenses to see profit trends.</small>
                </div>
            `;
            return;
        }

        // Group sales and expenses by month
        const allDates = [...this.sales.map(s => s.date), ...this.expenses.map(e => e.date)];
        const dateRange = [...new Set(allDates)].sort();
        
        const monthlyData = {};
        dateRange.forEach(date => {
            const month = date.substring(0, 7); // YYYY-MM format
            if (!monthlyData[month]) {
                monthlyData[month] = { revenue: 0, expenses: 0 };
            }
        });

        // Calculate monthly revenue
        this.sales.forEach(sale => {
            const month = sale.date.substring(0, 7);
            if (monthlyData[month]) {
                monthlyData[month].revenue += sale.amount || 0;
            }
        });

        // Calculate monthly expenses
        this.expenses.forEach(expense => {
            const month = expense.date.substring(0, 7);
            if (monthlyData[month]) {
                monthlyData[month].expenses += expense.amount || 0;
            }
        });

        const labels = Object.keys(monthlyData).sort();
        const revenueData = labels.map(month => monthlyData[month].revenue);
        const expenseData = labels.map(month => monthlyData[month].expenses);
        const profitData = labels.map(month => monthlyData[month].revenue - monthlyData[month].expenses);

        const chartData = {
            labels: labels.map(label => new Date(label + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
            datasets: [
                {
                    label: 'Revenue',
                    data: revenueData,
                    color: '#10b981',
                    fill: false
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    color: '#ef4444',
                    fill: false
                },
                {
                    label: 'Profit',
                    data: profitData,
                    color: '#2563eb',
                    fill: true
                }
            ]
        };

        setTimeout(() => {
            chartManager.createLineChart('productionTrendChart', chartData);
        }, 100);
    }

    loadPerformanceTable() {
        const cageStats = this.cages.map(cage => {
            const cageLogs = this.productionLogs.filter(log => log.cageId === cage.id);
            const cageFeedLogs = this.feedLogs.filter(log => log.cageId === cage.id);
            
            const totalEggs = cageLogs.reduce((sum, log) => {
                const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                return sum + eggs;
            }, 0);
            const totalFeed = cageFeedLogs.reduce((sum, log) => sum + (log.feedConsumed || log.amount || 0), 0) +
                           cageLogs.reduce((sum, log) => sum + (log.currentFeed || 0), 0);
            
            const layingRate = cage.currentBirds > 0 ?
                Calculations.calculateLayingPercentage(totalEggs, cage.currentBirds, cageLogs.length || 1) : 0;
            const feedEfficiency = Calculations.calculateFeedEfficiency(totalEggs, totalFeed);
            
            const performanceScore = layingRate * 0.6 + (feedEfficiency * 10) * 0.4;
            
            return {
                cage,
                totalEggs,
                layingRate,
                feedEfficiency,
                performanceScore
            };
        });

        cageStats.sort((a, b) => b.performanceScore - a.performanceScore);

        const tableBody = document.getElementById('performance-table');
        if (cageStats.length > 0) {
            tableBody.innerHTML = cageStats.map(stat => `
                <tr onclick="router.navigate('cage-detail', {id: ${stat.cage.id}})" style="cursor: pointer;">
                    <td><strong>${stat.cage.name}</strong></td>
                    <td>${stat.totalEggs.toLocaleString()}</td>
                    <td>
                        <span class="badge bg-${stat.layingRate > 80 ? 'success' : stat.layingRate > 60 ? 'warning' : 'danger'}">
                            ${stat.layingRate.toFixed(1)}%
                        </span>
                    </td>
                    <td>${stat.feedEfficiency.toFixed(2)}</td>
                    <td>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${Math.min(100, stat.performanceScore)}%"></div>
                        </div>
                        <small class="text-muted">${stat.performanceScore.toFixed(0)}/100</small>
                    </td>
                </tr>
            `).join('');
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        No production data available yet. Add some daily entries to see performance metrics.
                    </td>
                </tr>
            `;
        }
    }

    loadInsights() {
        const insights = this.generateInsights();
        const insightsList = document.getElementById('insights-list');
        
        if (insights.length === 0) {
            insightsList.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Getting Started</strong><br>
                    <small>Add some production data to receive insights and recommendations about your farm's performance.</small>
                </div>
            `;
        } else {
            insightsList.innerHTML = insights.map(insight => `
                <div class="alert alert-${insight.type} alert-dismissible">
                    <i class="fas ${insight.icon} me-2"></i>
                    <strong>${insight.title}</strong><br>
                    <small>${insight.description}</small>
                </div>
            `).join('');
        }
    }

    generateInsights() {
        const insights = [];
        
        // Check if we have any data first
        if (this.productionLogs.length === 0 || this.cages.length === 0) {
            return insights; // Return empty array to show "Getting Started" message
        }
        
        // Calculate overall metrics
        const totalProduction = this.productionLogs.reduce((sum, log) => {
            const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
            return sum + eggs;
        }, 0);
        const totalBirds = this.cages.reduce((sum, cage) => sum + (cage.currentBirds || 0), 0);
        const avgLayingRate = totalBirds > 0 ?
            Calculations.calculateLayingPercentage(totalProduction, totalBirds, this.productionLogs.length || 1) : 0;

        // Performance insights
        if (avgLayingRate > 85) {
            insights.push({
                type: 'success',
                icon: 'fa-thumbs-up',
                title: 'Excellent Performance',
                description: 'Your laying rate is above 85%, indicating excellent flock health and management.'
            });
        } else if (avgLayingRate < 60) {
            insights.push({
                type: 'warning',
                icon: 'fa-exclamation-triangle',
                title: 'Below Average Performance',
                description: 'Consider reviewing feeding schedules, health management, or environmental conditions.'
            });
        }

        // Feed efficiency insights  
        const totalFeed = this.feedLogs.reduce((sum, log) => sum + (log.feedConsumed || log.amount || 0), 0) +
                         this.productionLogs.reduce((sum, log) => sum + (log.currentFeed || 0), 0);
        const feedEfficiency = Calculations.calculateFeedEfficiency(totalProduction, totalFeed);
        
        if (feedEfficiency < 0.5) {
            insights.push({
                type: 'info',
                icon: 'fa-info-circle',
                title: 'Feed Efficiency Alert',
                description: 'Feed conversion ratio could be improved. Consider adjusting feed quality or quantity.'
            });
        }

        // Trend insights
        const recentLogs = this.productionLogs.slice(-7);
        const previousLogs = this.productionLogs.slice(-14, -7);
        
        if (recentLogs.length > 0 && previousLogs.length > 0) {
            const recentAvg = recentLogs.reduce((sum, log) => {
                const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                return sum + eggs;
            }, 0) / recentLogs.length;
            const previousAvg = previousLogs.reduce((sum, log) => {
                const eggs = log.eggsTrays ? log.eggsTrays * 30 : (log.eggsCollected || log.eggsProduced || 0);
                return sum + eggs;
            }, 0) / previousLogs.length;
            
            if (recentAvg > previousAvg * 1.1) {
                insights.push({
                    type: 'success',
                    icon: 'fa-trending-up',
                    title: 'Production Increasing',
                    description: 'Production has increased by more than 10% compared to the previous week.'
                });
            } else if (recentAvg < previousAvg * 0.9) {
                insights.push({
                    type: 'warning',
                    icon: 'fa-trending-down',
                    title: 'Production Declining',
                    description: 'Production has decreased by more than 10% compared to the previous week.'
                });
            }
        }

        return insights.slice(0, 4); // Limit to 4 insights
    }

    getFilteredLogs() {
        let logs = [...this.productionLogs];
        
        // Filter by date range
        if (this.dateRange !== 'all') {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(this.dateRange));
            logs = logs.filter(log => new Date(log.date) >= cutoffDate);
        }
        
        // Filter by cage
        if (this.currentFilter !== 'all') {
            logs = logs.filter(log => log.cageId === parseInt(this.currentFilter));
        }
        
        return logs;
    }

    getFilteredFeedLogs() {
        let logs = [...this.feedLogs];
        
        // Filter by date range
        if (this.dateRange !== 'all') {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(this.dateRange));
            logs = logs.filter(log => new Date(log.date) >= cutoffDate);
        }
        
        // Filter by cage
        if (this.currentFilter !== 'all') {
            logs = logs.filter(log => log.cageId === parseInt(this.currentFilter));
        }
        
        return logs;
    }

    updateDateRange(days) {
        this.dateRange = days;
        this.refreshAnalytics();
    }

    updateCageFilter(cageId) {
        this.currentFilter = cageId;
        this.refreshAnalytics();
    }

    updateCycleFilter(cycleId) {
        if (cycleId === 'all') {
            router.navigate('analytics');
        } else {
            router.navigate('analytics', { cycleId: cycleId });
        }
    }

    updateTimePeriod(period) {
        this.timePeriod = period;
        this.refreshChart();
    }

    updateMetricType(type) {
        this.metricType = type;
        this.refreshChart();
    }

    refreshChart() {
        this.loadChart();
    }

    refreshAnalytics() {
        this.loadAnalytics();
    }

    async exportData() {
        try {
            const exportData = {
                cycle: this.cycle,
                cages: this.cages,
                productionLogs: this.productionLogs,
                feedLogs: this.feedLogs,
                summary: {
                    totalProduction: this.productionLogs.reduce((sum, log) => sum + (log.eggsCollected || 0), 0),
                    totalFeed: this.feedLogs.reduce((sum, log) => sum + (log.amount || 0), 0),
                    avgLayingRate: this.calculateOverallLayingRate(),
                    exportDate: new Date().toISOString()
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `analytics-export-${this.cycle?.name || 'all-cycles'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            this.showToast('Analytics data exported successfully!', 'success');
        } catch (error) {
            console.error('Error exporting analytics data:', error);
            this.showToast('Error exporting data. Please try again.', 'error');
        }
    }

    calculateOverallLayingRate() {
        const totalProduction = this.productionLogs.reduce((sum, log) => sum + (log.eggsCollected || 0), 0);
        const totalBirds = this.cages.reduce((sum, cage) => sum + (cage.currentBirds || 0), 0);
        return totalBirds > 0 ? Calculations.calculateLayingPercentage(totalProduction, totalBirds, this.productionLogs.length || 1) : 0;
    }

    showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastBody = toast.querySelector('.toast-body');
        
        toastBody.textContent = message;
        
        const icon = toast.querySelector('.fas');
        icon.className = type === 'success' ? 'fas fa-check-circle text-success me-2' : 
                        type === 'error' ? 'fas fa-exclamation-circle text-danger me-2' : 
                        'fas fa-info-circle text-primary me-2';
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // Clear cache method for data clearing
    clearCache() {
        this.cycle = null;
        this.cycles = [];
        this.cages = [];
        this.productionLogs = [];
        this.feedLogs = [];
        this.sales = [];
        this.expenses = [];
        console.log('Analytics cache cleared');
    }
}

// Global analytics instance
const analytics = new Analytics();